<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture-to-Notes Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-text { background: linear-gradient(90deg, #8A2387 0%, #E94057 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .prose h1 { font-size: 1.8rem; font-weight: 700; margin-top: 1em; color: #1e293b; }
        .prose h2 { font-size: 1.4rem; font-weight: 600; margin-top: 1em; color: #334155; border-bottom: 1px solid #e2e8f0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #E94057; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>;

        // --- CODE-GENERATED LOGO COMPONENT ---
        const Logo = () => (
            <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/>
                        <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/>
                    </svg>
                </div>
                <span className="font-bold text-xl tracking-tight text-slate-800">
                    Lecture<span className="text-pink-600">Pro</span>
                </span>
            </div>
        );

        const Sidebar = ({ settings, setSettings }) => (
            <div className="w-80 bg-white border-r border-slate-200 h-screen fixed left-0 top-0 p-6 z-20 flex flex-col overflow-y-auto hidden lg:flex">
                
                <div className="mb-8">
                    <Logo />
                </div>

                <a href="https://buymeacoffee.com/lecturetonotes" target="_blank" className="mb-6 block hover:opacity-90"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" className="w-40" /></a>
                
                <div className="space-y-6 flex-1">
                    <div>
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Note Style</h3>
                        {["Summary (Concise)", "Comprehensive", "Exhaustive"].map(opt => (
                            <label key={opt} className="flex items-center gap-3 p-2 rounded hover:bg-slate-50 cursor-pointer">
                                <input type="radio" name="detail" checked={settings.detailLevel === opt} onChange={() => setSettings({...settings, detailLevel: opt})} className="accent-pink-600" />
                                <span className="text-sm text-slate-600">{opt}</span>
                            </label>
                        ))}
                    </div>
                    <div>
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Custom Focus</h3>
                        <textarea className="w-full p-3 bg-slate-50 border rounded-xl text-sm focus:outline-none focus:border-pink-500" rows="3" placeholder="e.g. 'Focus on dates'" value={settings.customFocus} onChange={(e) => setSettings({...settings, customFocus: e.target.value})} />
                    </div>
                </div>

                <div className="mt-auto space-y-4 pt-6 border-t">
                    <a href="https://amzn.to/483S2zn" target="_blank" className="block bg-slate-900 rounded-xl p-4 text-center text-white hover:scale-[1.02] transition-transform">
                        <div className="text-2xl mb-1">üéß</div>
                        <div className="font-bold text-sm">Apple AirPods 4</div>
                        <p className="text-xs text-slate-400">Active Noise Cancellation</p>
                        <span className="bg-white text-slate-900 text-xs font-bold px-3 py-1 rounded-full mt-2 inline-block">Check Price</span>
                    </a>
                    <div>
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">API Configuration</h3>
                        {settings.serverKeyReady ? (
                            <div className="bg-green-100 text-green-800 p-3 rounded-lg text-xs font-bold border border-green-200 flex items-center gap-2">
                                <span>‚úÖ</span> Server Key Active
                            </div>
                        ) : (
                            <input type="password" placeholder="Enter Gemini API Key" value={settings.apiKey} onChange={(e) => setSettings({...settings, apiKey: e.target.value})} className="w-full p-2 border rounded-lg text-xs" />
                        )}
                    </div>
                </div>
            </div>
        );

        // --- HELPER: DYNAMIC API URL (THE FIX) ---
        // We now use relative paths (e.g. "/chat") instead of "http://127.0.0.1:8000/chat"
        // This works on localhost AND on the real website automatically.
        const getApiUrl = (endpoint) => endpoint; 

        const ChatTab = ({ notes, apiKey }) => {
            const [msgs, setMsgs] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const send = async () => {
                if(!input) return;
                const userMsg = { role: "user", content: input };
                setMsgs([...msgs, userMsg]); setInput(""); setLoading(true);
                try {
                    const res = await fetch(getApiUrl('/chat'), { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ notes, message: userMsg.content, api_key: apiKey }) });
                    const data = await res.json();
                    setMsgs(prev => [...prev, { role: "ai", content: data.response }]);
                } catch(e) { alert("Chat Error"); }
                setLoading(false);
            };
            return (
                <div className="h-96 flex flex-col">
                    <div className="flex-1 overflow-y-auto space-y-4 p-4 border rounded-xl bg-slate-50 mb-4">
                        {msgs.map((m,i) => <div key={i} className={`p-3 rounded-lg max-w-[80%] ${m.role==='user' ? 'bg-blue-100 ml-auto' : 'bg-white border'}`}><p className="text-sm">{m.content}</p></div>)}
                        {loading && <div className="text-center text-xs text-slate-400">Thinking...</div>}
                    </div>
                    <div className="flex gap-2"><input className="flex-1 p-3 border rounded-xl" value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="Ask a question..." /><button onClick={send} className="bg-blue-600 text-white px-4 rounded-xl">Send</button></div>
                </div>
            );
        };

        const QuizTab = ({ notes, apiKey }) => {
            const [quiz, setQuiz] = useState(null);
            const [answers, setAnswers] = useState({});
            const [loading, setLoading] = useState(false);

            const genQuiz = async () => {
                setLoading(true); setQuiz(null); setAnswers({});
                try {
                    const res = await fetch(getApiUrl('/generate-quiz'), { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ notes, api_key: apiKey }) 
                    });
                    const data = await res.json();
                    setQuiz(data);
                } catch(e) { alert("Quiz Error"); }
                setLoading(false);
            };

            return (
                <div>
                    {!quiz && <button onClick={genQuiz} className="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold w-full transition hover:bg-purple-700">{loading ? "Generating..." : "Generate Quiz üé≤"}</button>}
                    {quiz && quiz.map((q, i) => (
                        <div key={i} className="mb-6 p-6 bg-white rounded-xl border shadow-sm">
                            <h4 className="font-bold text-lg mb-4 text-slate-800">{i+1}. {q.question}</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {q.options.map((opt, optIdx) => {
                                    const hasAnswered = answers[i] !== undefined;
                                    const isCorrectOption = optIdx === q.answer_index;
                                    const isSelected = answers[i] === optIdx;
                                    let btnClass = "bg-slate-50 hover:bg-slate-100 text-slate-700 border-slate-200"; 
                                    if (hasAnswered) {
                                        if (isCorrectOption) btnClass = "bg-green-100 border-green-500 text-green-900 font-semibold ring-1 ring-green-500"; 
                                        else if (isSelected) btnClass = "bg-red-100 border-red-500 text-red-900";
                                        else btnClass = "bg-slate-50 text-slate-400 opacity-60";
                                    }
                                    return (
                                        <button key={optIdx} disabled={hasAnswered} onClick={() => setAnswers({...answers, [i]: optIdx})} className={`p-4 rounded-lg border text-left text-sm transition-all relative ${btnClass}`}>
                                            <span className="font-bold mr-2 text-slate-400">{String.fromCharCode(65 + optIdx)}.</span>{opt}
                                            {hasAnswered && isCorrectOption && <span className="absolute right-4 top-4">‚úÖ</span>}
                                            {hasAnswered && isSelected && !isCorrectOption && <span className="absolute right-4 top-4">‚ùå</span>}
                                        </button>
                                    );
                                })}
                            </div>
                            {answers[i] !== undefined && (
                                <div className={`mt-3 text-xs font-bold ${answers[i] === q.answer_index ? 'text-green-600' : 'text-red-600'}`}>
                                    {answers[i] === q.answer_index ? "Correct!" : "Incorrect. The right answer is highlighted above."}
                                </div>
                            )}
                        </div>
                    ))}
                    {quiz && <button onClick={genQuiz} className="mt-8 text-slate-500 underline w-full text-center text-sm hover:text-slate-800">Regenerate Quiz</button>}
                </div>
            );
        };

        const MindMapTab = ({ notes, apiKey }) => {
            const [svg, setSvg] = useState(null);
            const [loading, setLoading] = useState(false);
            const genMap = async () => {
                setLoading(true);
                try {
                    const res = await fetch(getApiUrl('/generate-mindmap'), { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ notes, api_key: apiKey }) });
                    const data = await res.json();
                    const viz = new Viz();
                    const element = await viz.renderSVGElement(data.dot_code);
                    document.getElementById('graph').innerHTML = "";
                    document.getElementById('graph').appendChild(element);
                    setSvg(true);
                } catch(e) { alert("Mind Map Error"); }
                setLoading(false);
            };
            return (
                <div>
                    {!svg && <button onClick={genMap} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold w-full transition hover:bg-indigo-700">{loading ? "Drawing..." : "Generate Mind Map ‚ú®"}</button>}
                    <div id="graph" className="mt-6 overflow-x-auto p-4 bg-white rounded-xl border shadow-sm"></div>
                </div>
            );
        };

        const App = () => {
            const [settings, setSettings] = useState({ detailLevel: "Comprehensive", customFocus: "", apiKey: "", serverKeyReady: false });
            const [view, setView] = useState('home');
            const [results, setResults] = useState(null);
            const [status, setStatus] = useState("");
            const [tab, setTab] = useState("notes");
            
            useEffect(() => {
                // Use relative path for status check
                fetch('/api-status')
                    .then(res => res.json())
                    .then(data => {
                        if (data.has_key) {
                            setSettings(s => ({...s, serverKeyReady: true}));
                        }
                    })
                    .catch(err => console.log("Server check failed"));
            }, []);

            const handleSubmit = async (file, url, mode) => {
                if (!settings.apiKey && !settings.serverKeyReady) return alert("Please enter API Key");
                
                setView('processing'); setStatus(mode === 'transcript' ? "Fetching Transcript..." : "Downloading & Processing...");
                
                const formData = new FormData();
                formData.append('api_key', settings.apiKey || ""); 
                formData.append('detail_level', settings.detailLevel);
                formData.append('custom_focus', settings.customFocus);
                formData.append('mode', mode); 
                if (file) formData.append('file', file);
                if (url) formData.append('url', url);

                try {
                    // Use relative path for processing
                    const res = await fetch('/process-lecture', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.detail);
                    setResults(data.notes); setView('results');
                } catch (e) {
                    alert(e.message); setView('home');
                }
            };
            
            const downloadPDF = async () => {
                try {
                    const res = await fetch(getApiUrl('/generate-pdf'), { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ notes: results }) });
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = "notes.pdf"; a.click();
                } catch(e) { alert("PDF Error"); }
            };

            return (
                <div className="bg-slate-50 min-h-screen lg:pl-80">
                    <Sidebar settings={settings} setSettings={setSettings} />
                    <main className="p-8 max-w-5xl mx-auto">
                        {view === 'home' && (
                            <div className="space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="text-center py-10">
                                    <h1 className="text-5xl font-bold text-slate-900 mb-6">Turn Lectures into <span className="gradient-text">Super Notes</span></h1>
                                    <p className="text-lg text-slate-600 max-w-2xl mx-auto">Upload any video, audio, or YouTube link. Our AI breaks it down, analyzes every second, and creates the ultimate study guide.</p>
                                </div>
                                <div className="bg-white rounded-3xl p-10 border-2 border-dashed border-slate-200 hover:border-pink-400 text-center cursor-pointer group transition-all shadow-sm hover:shadow-md" onClick={() => document.getElementById('file').click()}>
                                    <input type="file" id="file" className="hidden" onChange={(e) => handleSubmit(e.target.files[0], null, 'upload')} />
                                    <div className="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform"><Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12"/></div>
                                    <h3 className="text-xl font-bold text-slate-800">Drop your lecture file</h3>
                                    <p className="text-slate-500 text-sm mt-2">MP4, MP3, MOV, M4A (Max 2GB)</p>
                                    <button className="mt-6 bg-slate-900 text-white px-6 py-2 rounded-lg text-sm font-bold group-hover:bg-pink-600 transition-colors">Browse Files</button>
                                </div>
                                
                                {/* --- NEW SLEEK YOUTUBE INPUT --- */}
                                <div className="bg-white p-3 rounded-full border border-slate-200 shadow-sm flex items-center gap-4 pl-5 pr-2 transition-all hover:shadow-md">
                                    <div className="p-2 bg-red-50 rounded-lg text-red-600 flex-shrink-0">
                                        <Icon className="w-6 h-6" d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z M9.75 15.02l5.75-3.27-5.75-3.27v6.54z"/>
                                    </div>
                                    <input 
                                        id="yt-url" 
                                        className="flex-1 py-3 outline-none text-base text-slate-700 placeholder:text-slate-400 bg-transparent font-medium" 
                                        placeholder="Paste YouTube URL here..." 
                                    />
                                    <div className="flex items-center gap-2 shrink-0">
                                        <button onClick={() => handleSubmit(null, document.getElementById('yt-url').value, 'transcript')} className="px-5 py-2.5 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold text-sm flex items-center gap-2 transition-colors">
                                            <span className="text-orange-500">‚ö°</span> Speed Run
                                        </button>
                                        <button onClick={() => handleSubmit(null, document.getElementById('yt-url').value, 'audio')} className="px-5 py-2.5 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold text-sm flex items-center gap-2 transition-colors">
                                            <span className="text-slate-500">üéß</span> Audio
                                        </button>
                                        <button onClick={() => handleSubmit(null, document.getElementById('yt-url').value, 'video')} className="px-5 py-2.5 rounded-full bg-red-600 hover:bg-red-700 text-white font-semibold text-sm flex items-center gap-2 transition-colors shadow-md hover:shadow-lg">
                                            <span>üìπ</span> Full Video
                                        </button>
                                    </div>
                                </div>

                                {/* --- ECHO 360 GUIDE --- */}
                                <div className="bg-blue-50 border border-blue-100 rounded-2xl p-6 text-blue-900/80 text-sm">
                                    <h3 className="font-bold mb-2 text-blue-900 text-lg">How to use Echo360 Recordings</h3>
                                    <div className="flex flex-col md:flex-row gap-6">
                                        <div className="flex-1">
                                            <h4 className="font-bold text-blue-700 mb-1">Option 1: Official Download</h4>
                                            <ol className="list-decimal list-inside space-y-1">
                                                <li>Go to your Echo360 Course page.</li>
                                                <li>Click the <strong>Green Video Icon</strong>.</li>
                                                <li>Select <strong>Download Original</strong>.</li>
                                            </ol>
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="font-bold text-blue-700 mb-1">Option 2: Browser Extension</h4>
                                            <ol className="list-decimal list-inside space-y-1">
                                                <li>Install "Echo360 Downloader" extension.</li>
                                                <li>Go to the lecture page.</li>
                                                <li>Click extension icon to save.</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'processing' && (
                            <div className="text-center py-20">
                                <div className="loader"></div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">AI is studying your lecture...</h3>
                                <p className="text-slate-500">{status}</p>
                            </div>
                        )}

                        {view === 'results' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center">
                                    <button onClick={() => setView('home')} className="text-sm text-slate-500 hover:text-pink-600 font-bold">‚Üê Process Another</button>
                                    <div className="flex gap-2 bg-white p-1 rounded-lg border">
                                        {['notes', 'chat', 'quiz', 'mindmap'].map(t => (
                                            <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded-md text-sm font-bold capitalize ${tab===t ? 'bg-slate-900 text-white' : 'text-slate-600 hover:bg-slate-50'}`}>{t}</button>
                                        ))}
                                    </div>
                                </div>
                                
                                {tab === 'notes' && (
                                    <div className="bg-white rounded-3xl shadow-xl p-10">
                                        <button onClick={downloadPDF} className="float-right bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded text-xs font-bold">Download PDF</button>
                                        <div className="prose max-w-none" dangerouslySetInnerHTML={{ __html: marked.parse(results) }} />
                                    </div>
                                )}
                                
                                {tab === 'chat' && <ChatTab notes={results} apiKey={settings.apiKey} />}
                                {tab === 'quiz' && <QuizTab notes={results} apiKey={settings.apiKey} />}
                                {tab === 'mindmap' && <MindMapTab notes={results} apiKey={settings.apiKey} />}
                            </div>
                        )}
                        
                        {/* Footer Ad */}
                        <div className="mt-20 p-8 rounded-3xl bg-gradient-to-r from-slate-900 to-slate-800 text-white text-center relative overflow-hidden">
                            <div className="relative z-10">
                                <h4 className="text-2xl font-bold mb-2">üöÄ Built with Python</h4>
                                <p className="text-slate-400 text-sm mb-6">Want to build your own AI apps? Start learning today.</p>
                                <a href="https://www.coursera.org/" target="_blank" className="inline-block bg-white text-slate-900 font-bold px-6 py-3 rounded-full hover:scale-105 transition-transform">Start Coding</a>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>